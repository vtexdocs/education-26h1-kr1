{% comment %}
  Renders nav from site.pages: docs folder hierarchy, collapsible sections.
  Excludes any path segment starting with '_'. Updates when Jekyll rebuilds (e.g. on deploy).
{% endcomment %}
{% assign id_prefix = include.id_prefix | default: "nav" %}
{% assign nav_pages = site.pages | sort: "url" %}

{% assign prev_seg1 = "" %}
{% assign prev_seg2 = "" %}
{% assign lid = "" %}
{% for p in nav_pages %}
  {% assign raw_path = p.url | remove_first: site.baseurl | strip %}
  {% assign path_trimmed = raw_path | remove_first: "/" | split: "?" | first | strip %}
  {% if path_trimmed == "" or path_trimmed == "index.html" %}{% continue %}{% endif %}
  {% assign parts = path_trimmed | split: "/" %}
  {% assign skip = false %}
  {% for part in parts %}
    {% assign first_char = part | slice: 0, 1 %}
    {% if first_char == "_" %}
      {% assign skip = true %}
      {% break %}
    {% endif %}
  {% endfor %}
  {% assign seg1 = parts[0] %}
  {% assign seg2 = parts[1] %}
  {% if seg1 == "assets" or seg1 == "" %}{% assign skip = true %}{% endif %}
  {% if skip %}{% continue %}{% endif %}
  {% assign parts_size = 0 %}
  {% for part in parts %}
    {% if part != "" %}
      {% assign parts_size = parts_size | plus: 1 %}
    {% endif %}
  {% endfor %}
  {% if parts_size == 0 %}{% continue %}{% endif %}
  {% comment %} Use non-empty segment count for hierarchy (trailing slash adds empty part) {% endcomment %}
  {% assign is_leaf = false %}
  {% if parts_size == 1 %}
    {% assign is_leaf = true %}
  {% endif %}
  {% assign last_parts_size = parts_size %}

  {% if seg1 != prev_seg1 %}
    {% if prev_seg1 != "" %}
      </ul></li>
    {% endif %}
    {% assign prev_seg1 = seg1 %}
    {% assign prev_seg2 = "" %}
    {% assign lid = id_prefix | append: "-" | append: seg1 | slugify %}
    {% if is_leaf %}
<li>
  <a href="{{ p.url | relative_url }}" {% if page.url == p.url %}class="active"{% endif %}>{{ p.title | default: p.name | replace: ".md", "" | replace: ".html", "" }}</a>
</li>
    {% else %}
<li>
  <div class="nav-item-head" role="button" tabindex="0" data-controls="{{ lid }}" aria-expanded="true" aria-label="Toggle {{ seg1 }}">
    <span class="nav-label">{{ seg1 | replace: "-", " " }}</span>
    <span class="nav-toggle" aria-hidden="true"></span>
  </div>
  <ul id="{{ lid }}" class="nav-children">
    {% endif %}
  {% endif %}

  {% unless is_leaf %}
    {% if parts_size == 2 %}
<li>
  <a href="{{ p.url | relative_url }}" {% if page.url == p.url %}class="active"{% endif %}>{{ p.title | default: p.name | replace: ".md", "" | replace: ".html", "" }}</a>
</li>
    {% elsif parts_size >= 3 %}
      {% assign seg2_slug = seg2 | slugify %}
      {% if seg2 != prev_seg2 %}
        {% if prev_seg2 != "" %}
        </ul></li>
        {% endif %}
        {% assign prev_seg2 = seg2 %}
        {% assign lid2 = lid | append: "-" | append: seg2_slug %}
<li>
  <div class="nav-item-head" role="button" tabindex="0" data-controls="{{ lid2 }}" aria-expanded="true" aria-label="Toggle {{ seg2 }}">
    <span class="nav-label">{{ seg2 | replace: "-", " " }}</span>
    <span class="nav-toggle" aria-hidden="true"></span>
  </div>
  <ul id="{{ lid2 }}" class="nav-children">
      {% endif %}
<li>
  <a href="{{ p.url | relative_url }}" {% if page.url == p.url %}class="active"{% endif %}>{{ p.title | default: p.name | replace: ".md", "" | replace: ".html", "" }}</a>
</li>
    {% endif %}
  {% endunless %}
{% endfor %}

{% if prev_seg1 != "" %}
  {% if prev_seg2 != "" %}
  </ul></li>
  {% endif %}
  </ul></li>
{% endif %}
